<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interacting Entities</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.18.0/cytoscape.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://unpkg.com/klayjs@0.4.1/klay.js"></script>
    <script src="/static/cytoscape-klay.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
              src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
     </script>
    <script src="utils.js"></script>
    <script>
        function filter(element) {
            var value = $(element).val().toLowerCase();

            $("ul > li").each(function() {
                if ($(this).text().toLowerCase().search(value) > -1) {
                    $(this).show();
                }
                else {
                    $(this).hide();
                }
            });
        }
    </script>
</head>
<style>
    .container {
        width: 33%;
        float: left;
    }
    li {
        font-size: small;
    }

    #freq-handle, #has-sig-handle, #avg-sig-handle, #avg-impact-handle, #max-impact-handle, #avg-pvalue-handle{
        width: 3em;
        height: 1.6em;
        top: 50%;
        margin-top: -.8em;
        text-align: center;
        line-height: 1.6em;
      }

      .slider{
          width: 80%;
      }

      .coefficient{
          display: flex;
          flex-direction: row;
          margin-top: 1em;
      }

      .coefficient .title{
          margin-right: 1em;
          width: 10%;
      }

          /* When the body has the loading class, we turn
       the scrollbar off with overflow:hidden */
    body.loading .modal {
        overflow: hidden;
    }

    /* Anytime the body has the loading class, our
       modal element will be visible */
    body.loading .modal {
        display: block;
    }

    /* Start by setting display:none to make this hidden.
   Then we position it in relation to the viewport window
   with position:fixed. Width, height, top and left speak
   for themselves. Background we set to 80% white with
   our animation centered, and no-repeating */
    .modal {
        display:    none;
        position:   fixed;
        z-index:    1000;
        top:        0;
        left:       0;
        height:     100%;
        width:      100%;
        background: rgba( 255, 255, 255, .8 )
                    url('http://i.stack.imgur.com/FhHRx.gif')
                    50% 50%
                    no-repeat;
    }

    #cy {
        height: 100vh;
        width: 100%;
        z-index: 0;
        /*background-color: lightgrey;*/
        /*width: 100%;*/
        /*height: 5in;*/
        /*position:relative;*/
        /*background-color: pink;*/
        /*   left:0px;*/
        /*   top:0px;*/
    }
    #ev
</style>
<body>
    <h4><a href="/static/viz.html">Enter query directly</a></h4>
    <h1>Overview of entities interacting with IL-6 (uniprot:P05231)</h1>

    <h2>Weighting <a href="#" id="toggle_weight" style="font-size: small;">[Show]</a></h2>
      <div id="weight_group" style="display: none">
          <span id="formula"></span>
      <span class="coefficient">
          <div class="title">Frequency:</div>
          <div id="freq-slider" class="slider">
            <div id="freq-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Has significance:</span>
          <div id="has-sig-slider" class="slider">
            <div id="has-sig-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Avg significance:</span>
          <div id="avg-sig-slider" class="slider">
            <div id="avg-sig-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Avg impact factor:</span>
          <div id="avg-impact-slider" class="slider">
            <div id="avg-impact-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Max impact factor:</span>
          <div id="max-impact-slider" class="slider">
            <div id="max-impact-handle" class="ui-slider-handle"></div>
          </div>
      </span>

      <span class="coefficient">
          <span class="title">1 - Avg p-value:</span>
          <div id="avg-pvalue-slider" class="slider">
            <div id="avg-pvalue-handle" class="ui-slider-handle"></div>
          </div>
      </span>
    </div>

    <div id="cy"></div>

    <script>


        function weight_result(data){
                let influenced = data.influenced
                let influencers = data.influencers
                let reciprocals = data.reciprocals

               function helper(elems){
                    elems.forEach(elem => {
                       elem[3]['freq'] = elem[2]
                    })

                    elems.forEach(elem => {
                        const w = arizona_weight(elem[3])
                        elem[4] = w
                    })
               }

               helper(influenced)
               helper(influencers)
               helper(reciprocals)

           }

        const cy = cytoscape({
          container: document.getElementById('cy'),
            style: [
        {
            selector: 'node',
            style: {
                shape: 'ellipse',
                width: "1em",
                height: "1em",
                'background-color': 'yellow',
                label: (ele) => { return ele.data()['label'] + ` (${ele.data()['id']}) - W: ${ele.data()['weight'].toFixed(2)}`},
                // 'font-size': '.3em'
            }
        },

          {
            selector: 'edge',
            style: {
                // 'width': 'data(freq)',
                width: function(ele){
                    if(ele.id().startsWith("cluster_"))
                        return 1
                    else
                        return 3//arizona_weight(ele.data())
                },
                label: (ele) => {
                    if(ele.id().startsWith("cluster_"))
                        return `Click to Expand (${ele.data()['freq']}) ...`
                    else
                        return "test"
                },
                "text-rotation": "autorotate",
                "line-color": "black",
                // 'target-arrow-color': (elem) => { return color_by_label(elem, arrow=true) },
                // 'display': (elem) => { return elem.id().startsWith("cluster_")?'element':'none' }
            }
        },
        {
            selector: '.reciprocal',
            style: {
                "background-color": "green"
            }
        },
        {
            selector: '.influencer',
            style: {
                "background-color": "blue"
            }
        },
        {
            selector: '.influenced',
            style: {
                "background-color": "red"
            }
        }

        ],
            elements: []
        });

        const rootId = "uniprot:P05231";

        $(function(){
            let data = Array();

            function refresh(){
                populateList()
                renderFormula()
            }

            function populateList() {
               $("body").addClass("loading");
               weight_result(data)
               let influenced = data.influenced
               let influencers = data.influencers
               let reciprocals = data.reciprocals

               const root = {
                    "group": "nodes",
                    "data": {
                        "id": rootId,
                        "label": "IL-6"
                    }
                }

               function createGraphElements(collection, classes){
                   return collection.flatMap(
                       elem => {
                           const id = elem[0]
                           const label = elem[1]
                           const freq = elem[2]
                           const weight = elem[4]

                           const node = {
                               "group": 'nodes',
                               "data": {
                                   "id": id,
                                   "label": label,
                                   "weight": weight,
                                   "link": `/static/viz.html?dst=IL6 (uniprot:P05231)&src=${label} (${id})&bidirect`
                               },
                               classes: classes

                           }

                           const edge = {
                               "data": {
                                   "id": `e${id}`,
                                   "freq": freq,
                                   "weight": weight,
                                   "source": rootId,
                                   "target": id
                               }
                           }

                           return [node]


                       }
                   )
               }

               let influencedEdges = createGraphElements(influenced, ["influenced"])
               let influencingEdges = createGraphElements(influencers, ["influencer"])
               let reciprocalEdges = createGraphElements(reciprocals, ["reciprocal"])




            // This is a double click event
            let tappedBefore;
            let tappedTimeout;
            cy.on('click', function(event) {
              let tappedNow = event.target;
              if (tappedTimeout && tappedBefore) {
                clearTimeout(tappedTimeout);
              }
              if(tappedBefore === tappedNow) {
                tappedNow.trigger('dbclick');
                tappedBefore = null;
              } else {
                tappedTimeout = setTimeout(function(){ tappedBefore = null; }, 300);
                tappedBefore = tappedNow;
              }
            });
            /////////////////////////////

            let layoutInitialOpts = {
                name: 'grid',
                cols:10,
                nodeDimensionsIncludeLabels: true,
                sort: function(a, b){
                    a_kind = a.classes()[0]
                    b_kind = b.classes()[0]
                    if(a_kind === b_kind)
                        return a.data('weight') - b.data('weight')
                    else{
                        if(a_kind === "influencer")
                            return 1
                        else if(a_kind === "reciprocal" && b_kind === "influenced")
                            return 1
                        else
                            return -1
                    }
                }
              }


            let elems = influencedEdges.concat(influencingEdges).concat(reciprocalEdges)

            cy.json({"elements": elems})
            cy.layout(layoutInitialOpts).run();
            cy.fit(cy.elements())

               $("body").removeClass("loading");
           }

            $.getJSON(`/overview/uniprot:P05231/`,
              result => {
                  data = result
                  populateList();

                    // Bind a double click event to the nodes, to navigate to the specific view if desired
                    cy.on('dbclick', 'node', function(evt){
                        let node = evt.target
                        if(node.id() !== rootId){
                            window.location.href = node.data()['link'];
                        }
                    })
              }
            )


            const showWeightControls = window.localStorage.getItem("show-weight")

            if(showWeightControls === "true"){
                $("#weight_group").show()
                $("#toggle_weight").text("[Hide]")
            }

            $("#toggle_weight").click(() => {
                if(!$("#weight_group").is(":hidden")){
                    $("#weight_group").hide()
                    $("#toggle_weight").text("[Show]")
                    window.localStorage.setItem("show-weight", false)
                }
                else{
                    $("#weight_group").show()
                    $("#toggle_weight").text("[Hide]")
                    window.localStorage.setItem("show-weight", true)
                }
            })

            var freqHandle = $( "#freq-handle" );
                $( "#freq-slider" ).slider({
                    create: function () {
                        freqHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("freq", ui.value)
                        freqHandle.text(ui.value);
                    },
                    stop:refresh,
                    step:0.1,
                    value: readSliderValue("freq"),
                    max: 20
                 });

                var hasSigHandle = $( "#has-sig-handle" );
                $( "#has-sig-slider" ).slider({
                    create: function () {
                        hasSigHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("has-sig", ui.value)
                        hasSigHandle.text(ui.value);
                    },
                    stop:refresh,
                    step:0.1,
                    value: readSliderValue("has-sig"),
                    max: 20
                 });

                var avgSigHandle = $( "#avg-sig-handle" );
                $( "#avg-sig-slider" ).slider({
                    create: function () {
                        avgSigHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("avg-sig", ui.value)
                        avgSigHandle.text(ui.value);
                    },
                    step:0.1,
                    stop:refresh,
                    value: readSliderValue("avg-sig"),
                    max: 20
                 });

                var avgImpactHandle = $( "#avg-impact-handle" );
                $( "#avg-impact-slider" ).slider({
                    create: function () {
                        avgImpactHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("avg-impact", ui.value)
                        avgImpactHandle.text(ui.value);
                    },
                    step:0.1,
                    stop:refresh,
                    value: readSliderValue("avg-impact"),
                    max: 20
                 });

                var maxImpactHandle = $( "#max-impact-handle" );
                $( "#max-impact-slider" ).slider({
                    create: function () {
                        maxImpactHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("max-impact", ui.value)
                        maxImpactHandle.text(ui.value);
                    },
                    step:0.1,
                    stop:refresh,
                    value: readSliderValue("max-impact"),
                    max: 20
                 });

                const avgPval = $("#avg-pvalue-handle");
                    $( "#avg-pvalue-slider" ).slider({
                        create: function () {
                            avgPval.text($(this).slider("value"));
                        },
                        slide: function (event, ui) {
                            setSliderValue("avg-pvalue", ui.value)
                            avgPval.text(ui.value);
                        },
                        step:0.1,
                        stop:refresh,
                        value: readSliderValue("avg-pvalue"),
                        max: 20
                 });

            renderFormula()
        })

    </script>

<div class="modal"><!-- Place at bottom of page --></div>
</body>
</html>