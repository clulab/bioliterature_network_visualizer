<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interacting Entities</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
              src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
     </script>
    <script src="utils.js"></script>
    <script>
        function filter(element) {
            const value = $(element).val().toLowerCase();

            $("ul > li").each(function() {
                if ($(this).text().toLowerCase().search(value) > -1) {
                    $(this).show();
                }
                else {
                    $(this).hide();
                }
            });
        }
    </script>
</head>
<style>
    .container {
        width: 30%;
        float: left;
        margin-right: 3%;
    }
    li {
        font-size: small;
    }

    #freq-handle, #has-sig-handle, #avg-sig-handle, #avg-impact-handle, #max-impact-handle, #avg-pvalue-handle{
        width: 3em;
        height: 1.6em;
        top: 50%;
        margin-top: -.8em;
        text-align: center;
        line-height: 1.6em;
      }

      .slider{
          width: 80%;
      }

      .coefficient{
          display: flex;
          flex-direction: row;
          margin-top: 1em;
      }

      .coefficient .title{
          margin-right: 1em;
          width: 10%;
      }

          /* When the body has the loading class, we turn
       the scrollbar off with overflow:hidden */
    body.loading .modal {
        overflow: hidden;
    }

    /* Anytime the body has the loading class, our
       modal element will be visible */
    body.loading .modal {
        display: block;
    }

    /* Start by setting display:none to make this hidden.
   Then we position it in relation to the viewport window
   with position:fixed. Width, height, top and left speak
   for themselves. Background we set to 80% white with
   our animation centered, and no-repeating */
    .modal {
        display:    none;
        position:   fixed;
        z-index:    1000;
        top:        0;
        left:       0;
        height:     100%;
        width:      100%;
        background: rgba( 255, 255, 255, .8 )
                    url('http://i.stack.imgur.com/FhHRx.gif')
                    50% 50%
                    no-repeat;
    }
</style>
<body>
    <h4><a href="/static/viz.html">Enter query directly</a></h4>
    <h1>Overview of entities interacting with IL-6 (uniprot:P05231)</h1>
    <label for="order">Order by:</label> <select name="order" id="order">
        <option value="weight">Custom Weight</option>
        <option value="freq">Frequency</option>
        <option value="name">Name</option>
        <option value="gid">Database I.D.</option>
    </select>
    <label>Filter by:</label> <input type="text" id="filter" onkeyup="filter(this)">
    <h2>Weighting <a href="#" id="toggle_weight" style="font-size: small;">[Show]</a></h2>
      <div id="weight_group" style="display: none">
          <span id="formula"></span>
      <span class="coefficient">
          <div class="title">Frequency:</div>
          <div id="freq-slider" class="slider">
            <div id="freq-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Has significance:</span>
          <div id="has-sig-slider" class="slider">
            <div id="has-sig-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Avg significance:</span>
          <div id="avg-sig-slider" class="slider">
            <div id="avg-sig-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Avg impact factor:</span>
          <div id="avg-impact-slider" class="slider">
            <div id="avg-impact-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Max impact factor:</span>
          <div id="max-impact-slider" class="slider">
            <div id="max-impact-handle" class="ui-slider-handle"></div>
          </div>
      </span>

      <span class="coefficient">
          <span class="title">1 - Avg p-value:</span>
          <div id="avg-pvalue-slider" class="slider">
            <div id="avg-pvalue-handle" class="ui-slider-handle"></div>
          </div>
      </span>
    </div>

    <div style="width: 100%">
        <div id="influenced" class="container">
            <h3>Influenced by:</h3>
        </div>
        <div id="reciprocal" class="container">
            <h3>Reciprocal with:</h3>
        </div>
        <div id="influencers" class="container">
            <h3>Influence:</h3>
        </div>

    </div>
    <script>

        function weight_result(data){
            let influenced = data.influenced
            let influencers = data.influencers
            let reciprocals = data.reciprocals

           function helper(elems){
                elems.forEach(elem => {
                   elem[3]['freq'] = elem[2]
                })

                elems.forEach(elem => {
                    elem[4] = arizona_weight(elem[3])
                })
           }

           helper(influenced)
           helper(influencers)
           helper(reciprocals)

       }



        $(function(){
            let data = Array();

            function refresh(){
                populateList()
                renderFormula()
            }

            function populateList() {
                $("body").addClass("loading");
                weight_result(data)
                let influenced = data.influenced
                let influencers = data.influencers
                let reciprocals = data.reciprocals

                const orderControl = $("#order")
                const orderCriteria = orderControl.val()

                let elementIx

                if(orderCriteria === 'freq')
                    elementIx = 2
                else if(orderCriteria === "name")
                    elementIx = 1
                else if(orderCriteria === "weight")
                    elementIx = 4
                else
                    elementIx = 0

                influenced.sort((a, b) => a[elementIx] < b[elementIx] ? 1 : -1)
                reciprocals.sort((a, b) => a[elementIx] < b[elementIx] ? 1 : -1)
                influencers.sort((a, b) => a[elementIx] < b[elementIx] ? 1 : -1)

                const categories = {
                    "uniprot": "Proteins or Gene Products",
                    "mesh": "Diseases",
                    "go": "Biological Process",
                    "fplx": "Proteins or Gene Products",
                    "pubchem": "Chemicals",
                    "interpro": "Proteins or Gene Products",
                    "proonto": "Proteins or Gene Products",
                    "chebi": "Chemicals",
                    "pfam": "Proteins or Gene Products",
                    "frailty": "Biological Process"
                }

                function createAccordion(groups, containerId) {

                    const container = $(containerId)
                    // Add a section for each group
                    for(const group in groups) {
                        const entries = groups[group]
                        const category = categories[group] || group
                        container.append(`<h3>${category}</h3>`)
                        const d = $(document.createElement("div").appendChild(document.createElement("ul")))

                        for(const e of entries){
                            d.append(`<li><a href="/static/viz.html?dst=IL6 (uniprot:P05231)&src=${e.label} (${e.id})&bidirect">${e.label} (${e.id})</a> - F: ${e.freq} - W: ${e.weight.toFixed(2)}</li>`)
                        }
                        container.append(d)
                    }

                    // Make it accordion
                    container.accordion({
                        collapsible:true,
                        heightStyle: "content",
                    })
                }

                function populateSubList(containedId) {
                    const lastChild = $(containedId).children().last()
                    if(lastChild.is("span"))
                        lastChild.remove()
                    $(containedId).append($("<span>"))
                    containedId += " span"

                    const entries = reciprocals.map(
                        elem => {
                            const id = elem[0]
                            const label = elem[1]
                            const freq = elem[2]
                            const weight = elem[4]

                            const entityCategory = getEntityCategory(id)

                            const entry = {
                                "id": id,
                                "label": label,
                                "cat": entityCategory,
                                "freq": freq,
                                "weight": weight
                            }
                            return entry

                        }
                    )

                    const entriesByType = groupBy(entries, entry => categories[entry.cat] || entry.cat)

                    createAccordion(entriesByType, containedId);
                }


                populateSubList("#influenced");

                populateSubList("#influencers");

                populateSubList("#reciprocal");

                $("body").removeClass("loading");
            }

            $.getJSON(`/overview/uniprot:P05231/`,
              result => {
                  data = result
                  populateList();
              }
            )

            document.querySelector('#order').addEventListener('change', refresh);


            const showWeightControls = window.localStorage.getItem("show-weight")

            if(showWeightControls === "true"){
                $("#weight_group").show()
                $("#toggle_weight").text("[Hide]")
            }

            $("#toggle_weight").click(() => {
                if(!$("#weight_group").is(":hidden")){
                    $("#weight_group").hide()
                    $("#toggle_weight").text("[Show]")
                    window.localStorage.setItem("show-weight", false)
                }
                else{
                    $("#weight_group").show()
                    $("#toggle_weight").text("[Hide]")
                    window.localStorage.setItem("show-weight", true)
                }
            })

            var freqHandle = $( "#freq-handle" );
                $( "#freq-slider" ).slider({
                    create: function () {
                        freqHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("freq", ui.value)
                        freqHandle.text(ui.value);
                        refresh();
                    },

                    step:0.1,
                    value: readSliderValue("freq"),
                    max: 20
                 });

                var hasSigHandle = $( "#has-sig-handle" );
                $( "#has-sig-slider" ).slider({
                    create: function () {
                        hasSigHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("has-sig", ui.value)
                        hasSigHandle.text(ui.value);
                        refresh();
                    },
                    step:0.1,
                    value: readSliderValue("has-sig"),
                    max: 20
                 });

                var avgSigHandle = $( "#avg-sig-handle" );
                $( "#avg-sig-slider" ).slider({
                    create: function () {
                        avgSigHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("avg-sig", ui.value)
                        avgSigHandle.text(ui.value);
                        refresh();
                    },
                    step:0.1,
                    value: readSliderValue("avg-sig"),
                    max: 20
                 });

                var avgImpactHandle = $( "#avg-impact-handle" );
                $( "#avg-impact-slider" ).slider({
                    create: function () {
                        avgImpactHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("avg-impact", ui.value)
                        avgImpactHandle.text(ui.value);
                        refresh();
                    },
                    step:0.1,
                    value: readSliderValue("avg-impact"),
                    max: 20
                 });

                var maxImpactHandle = $( "#max-impact-handle" );
                $( "#max-impact-slider" ).slider({
                    create: function () {
                        maxImpactHandle.text($(this).slider("value"));
                    },
                    slide: function (event, ui) {
                        setSliderValue("max-impact", ui.value)
                        maxImpactHandle.text(ui.value);
                        refresh();
                    },
                    step:0.1,
                    value: readSliderValue("max-impact"),
                    max: 20
                 });

                const avgPval = $("#avg-pvalue-handle");
                    $( "#avg-pvalue-slider" ).slider({
                        create: function () {
                            avgPval.text($(this).slider("value"));
                        },
                        slide: function (event, ui) {
                            setSliderValue("avg-pvalue", ui.value)
                            avgPval.text(ui.value);
                            refresh();
                        },
                        step:0.1,
                        value: readSliderValue("avg-pvalue"),
                        max: 20
                 });

            renderFormula()
        })

    </script>

<div class="modal"><!-- Place at bottom of page --></div>
</body>
</html>