<!doctype html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>Hypothesis searcher</title>
    <!-- <script src='cytoscape.js'></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.18.0/cytoscape.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
     <script src="https://unpkg.com/dagre@0.7.4/dist/dagre.js"></script>
    <script src="/static/cytoscape-dagre.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/elkjs@0.7.0/lib/elk.bundled.js"></script>
    <script src="/static/cytoscape-elk.js"></script>
    <script src="https://unpkg.com/klayjs@0.4.1/klay.js"></script>
    <script src="/static/cytoscape-klay.js"></script>

    <script>

    </script>
</head>

<style>
    body{
        background-color:#fafafa;
    }
    .container {
      /*display: flex;*/
      /*flex-direction: column;*/
        position: absolute;
        left: 0px;
        top: 0px;
        z-index: 1;
        background-color:rgba(207,207,196, 0.5);
        padding: 1em;
        padding-top: 0em;
        border-radius: 25px;
    }

    /*.Strong {*/
    /*    color:Blue;*/
    /*}*/
    /*.Weak{*/
    /*    color: Orange;*/
    /*}*/
    /*.Negations{*/
    /*    color: Red;*/
    /*}*/

    /*.Positive{*/
    /*    color: Green;*/
    /*    font-weight: bold;*/
    /*}*/

    /*.Negative{*/
    /*    color: Red;*/
    /*    font-weight: bold;*/
    /*}*/

    /*.Neutral{*/
    /*    font-weight: bold;*/
    /*}*/

    .event {
        background-color: #D1D1CD;
        padding: 0 .2em 0 .2em;
        border-radius: 3px;
    }

    .Positive_association {
        background-color: rgba(119, 221, 119, 0.25);
    }

    .Positive_activation{
        background-color: rgba(119, 221, 119, 0.25);
    }

    .Negative_association {
        background-color: rgba(255, 65, 55, 0.25);
    }

    .Negative_activation{
        background-color: rgba(255, 65, 55, 0.25);
    }

    .event > .argument.trigger {
        font-weight: bold;
        text-decoration: none;
        font-style: normal;
    }

    .event > .argument  {
        font-style: italic;
        text-decoration: underline;
    }

    #cy {
        height: 100vh;
        width: 100%;
        z-index: 0;
        /*background-color: lightgrey;*/
        /*width: 100%;*/
        /*height: 5in;*/
        /*position:relative;*/
        /*background-color: pink;*/
        /*   left:0px;*/
        /*   top:0px;*/
    }
    #evidence_pane {
        width: 100%;
        min-height: 20vh;
        /*z-index: 1;*/
        /*position: fixed;*/
        left: 0px;
        bottom: 0px;
        display: none;
        padding: 1em;
        margin: 0px;
        background-color:rgba(207,207,196, 0.5);
        border-radius: 25px;
        /*height: 87%;*/
        /*position:fixed;*/
       /*left:0px;*/
       /* top:13%;*/
       /* overflow: scroll;*/
    }

    /* Start by setting display:none to make this hidden.
   Then we position it in relation to the viewport window
   with position:fixed. Width, height, top and left speak
   for themselves. Background we set to 80% white with
   our animation centered, and no-repeating */
    .modal {
        display:    none;
        position:   fixed;
        z-index:    1000;
        top:        0;
        left:       0;
        height:     100%;
        width:      100%;
        background: rgba( 255, 255, 255, .8 )
                    url('http://i.stack.imgur.com/FhHRx.gif')
                    50% 50%
                    no-repeat;
    }

    /* When the body has the loading class, we turn
       the scrollbar off with overflow:hidden */
    body.loading .modal {
        overflow: hidden;
    }

    /* Anytime the body has the loading class, our
       modal element will be visible */
    body.loading .modal {
        display: block;
    }

    #weighting {
        position: absolute;
        left: 900px;
        top: 0px;
        z-index: 1;
        background-color:rgba(207,207,196, 0.5);
        padding: 1em;
        padding-top: 0em;
        border-radius: 25px;
    }

      #freq-handle, #has-sig-handle, #avg-sig-handle {
        width: 3em;
        height: 1.6em;
        top: 50%;
        margin-top: -.8em;
        text-align: center;
        line-height: 1.6em;
      }

      .slider{
          width: 80%;
      }

      .coefficient{
          display: flex;
          flex-direction: row;
          margin-top: 1em;
      }

      .coefficient .title{
          margin-right: 1em;
          width: 20%;
      }

</style>

<body>
  <div class="container">
      <h4><a href="/"/>Back to overview</a></h4>
      <h1>Query</h1><br />
      <b>Source: </b><input type="text" id="source" class="entity"/> <b>Destination: </b><input type="text"
                                                                                                id="destination"
                                                                                                class="entity"/>
      <b>Bidirectional: </b><input type="checkbox" id="bidirectional"><input id="ask" type="button" value="Find" />
      <h2>Weighting <a href="#" id="toggle_weight" style="font-size: small;">[Show]</a></h2>
      <div id="weight_group" style="display: none">
      <span class="coefficient">
          <div class="title">Frequency:</div>
          <div id="freq-slider" class="slider">
            <div id="freq-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Has significance:</span>
          <div id="has-sig-slider" class="slider">
            <div id="has-sig-handle" class="ui-slider-handle"></div>
          </div>
      </span>
      <span class="coefficient">
          <span class="title">Avg significance:</span>
          <div id="avg-sig-slider" class="slider">
            <div id="avg-sig-handle" class="ui-slider-handle"></div>
          </div>
      </span>
          </div>
  </div>

  <div id="cy"></div>
  <div id="evidence_pane">
       <h3>Evidence: <a href="#" id="close_evidence">[Close]</a></h3>
        <ul id="evidence" />

    </ul>
  </div>
    <script>
        const cy = cytoscape({
          container: document.getElementById('cy'),
            // zoom: 0.5,
            style: [
        {
            selector: 'node',
            style: {
                shape: 'ellipse',
                // size: "1em",
                'background-color': 'red',
                label: (ele) => { return ele.data()['label'] + ` (${ele.data()['id']})`},
                // 'font-size': '.3em'
            }
        },

          {
            selector: 'edge',
            style: {
                // 'width': 'data(freq)',
                width: function(ele){
                    if(ele.id().startsWith("cluster_"))
                        return 1
                    else
                        return arizona_weight(ele)
                },
                label: (ele) => {
                    if(ele.id().startsWith("cluster_"))
                        return `Click to Expand (${ele.data()['freq']}) ...`
                    else
                        return make_label(ele)//ele.data()['polarity']
                },
                "text-rotation": "autorotate",
                "line-color": color_by_label,
                'target-arrow-color': (elem) => { return color_by_label(elem, arrow=true) },
                'display': (elem) => { return elem.id().startsWith("cluster_")?'element':'none' }
            }
        }],
        elements: []
        });

        function resize_edges() {
            const edges = cy.edges().filter(e => !e.id().startsWith("cluster_"))

            edges.forEach(
                e => {
                    const weight = arizona_weight(e)
                    const label = make_label(e)
                    e.style("width", weight)
                    e.style("label", label)
                }
            )
        }

        function readSliderValue(name){

            const localStorage = window.localStorage
            const weight = localStorage.getItem(`${name}-weight`)
            if(!weight)
                return 1.
            else
                return weight
        }

        function setSliderValue(name, val){
            const localStorage = window.localStorage
            localStorage.setItem(`${name}-weight`, val)
        }

        $( function() {
            var freqHandle = $( "#freq-handle" );
            $( "#freq-slider" ).slider({
                create: function () {
                    freqHandle.text($(this).slider("value"));
                },
                slide: function (event, ui) {
                    setSliderValue("freq", ui.value)
                    freqHandle.text(ui.value);
                    resize_edges();
                },

                step:0.1,
                value: readSliderValue("freq"),
                max: 20
             });

            var hasSigHandle = $( "#has-sig-handle" );
            $( "#has-sig-slider" ).slider({
                create: function () {
                    hasSigHandle.text($(this).slider("value"));
                },
                slide: function (event, ui) {
                    setSliderValue("has-sig", ui.value)
                    hasSigHandle.text(ui.value);
                    resize_edges();
                },
                step:0.1,
                value: readSliderValue("has-sig"),
                max: 20
             });

            var avgSigHandle = $( "#avg-sig-handle" );
            $( "#avg-sig-slider" ).slider({
                create: function () {
                    avgSigHandle.text($(this).slider("value"));
                },
                slide: function (event, ui) {
                    setSliderValue("avg-sig", ui.value)
                    avgSigHandle.text(ui.value);
                    resize_edges();
                },
                step:0.1,
                value: readSliderValue("avg-sig"),
                max: 20
             });
        } );

        const expanded = {}

        let layoutOpts = {
            name:"klay",
            fit: true
            // spacingFactor: 10,
            // klay:{
            //     spacing: 300
            // }
        }

        let layoutInitialOpts = {
            name:"klay",
            spacingFactor: 10,
            fit: true,
            klay:{

            }
        }

        function color_by_label(elem, arrow=false){
            if(elem.id().startsWith("cluster_"))
                return "brown"
            else {
                let label = elem.data()['polarity'].toLowerCase()
                if (label === "positive")//(label.endsWith("(positive)") || label === "positive_association")
                    if (arrow)
                        return "#77DD77"
                    else
                        return "#DAF7A6"
                else if (label === "negative")//(label.endsWith("(negative)") || label === "negative_association")
                    if (arrow)
                        return "#ff4137"
                    else
                        return "#FAA0A0"
                else
                    return "#cfcfc4"
            }
        }

        function arizona_weight(elem){

            const freq_w = readSliderValue("freq")
            const has_sig_w = readSliderValue("has-sig")
            const avg_sig_w = readSliderValue("avg-sig")

            const d = elem.data()
            return  freq_w * Math.log((d['freq'] + 1)) +
                has_sig_w * ('has_significance' in d ? +d['has_significance'] : 0.) +
                avg_sig_w * Math.pow('percentage_significance' in d ? 2*d['percentage_significance'] : 0., 2)
        }

        function make_label(elem){
            const data = elem.data()
            const polarity = data['polarity'];
            const w = arizona_weight(elem)
            const freq = data['freq']
            return `${polarity} (${freq}) W: ${w.toFixed(2)}`
        }


        cy.style().selector('edge').style('curve-style', 'bezier')
        .style('target-arrow-shape','triangle').update()


        cy.bind('click', 'edge', function(event) {
          let edge = event.target


            if(edge.id().startsWith("cluster_")){
                let prefix = edge.id().split('_')[1]
                cy.filter(function(ele){return ele.id().startsWith(prefix)}).forEach(
                    (e) => {
                        e.style("display", "element")
                    }
                )
                edge.style("display", "none")
            }
            else{
                let evidence = []
                 $("body").addClass("loading");
                    document.getElementById("evidence").innerHTML = ""
                  $.getJSON(`/evidence/${edge.source().id()}/${edge.target().id()}/${edge.data()['polarity']}`,
                      data => {
                          evidence = data
                          evidence.forEach(item => {
                              document.getElementById("evidence").innerHTML += "<li>" + item.replace(/PMC\d+/, "<a href=\"https://www.ncbi.nlm.nih.gov/pmc/articles/$&/\" target=\"_blank\">$&</a>") + "</li>";
                          });
                          $("body").removeClass("loading");
                          $("#evidence_pane").show()
                          document.getElementById("evidence_pane").scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"});
                      }
          )

            }






        })

        cy.layout(layoutOpts).run();
        cy.fit(cy.elements())
        cy.zoom(1)

        $("#ask").click(
            function () {
                let pattern = /^.+ \(([^\(\)]+)\)$/
                let src = $("#source").val()
                let dst = $("#destination").val()
                let bidirect = $("#bidirectional").prop('checked')
                if(pattern.test(src)) {
                    src = src.match(pattern)[1]
                }
                if(pattern.test(dst))
                    dst = dst.match(pattern)[1]
                var url = `/interaction/${src}/${dst}/${bidirect}`
                $.getJSON(url, function (data) {  // success callback
                    let elements = JSON.parse(data)
                    cy.json({elements: elements})
                    cy.layout(layoutInitialOpts).run();
                    cy.fit(cy.elements())
                    cy.zoom(1)
                });
                document.getElementById("evidence").innerHTML = ""
            }
        )

        let tappedBefore;
        let tappedTimeout;

        cy.on('tap', function(event) {
          var tappedNow = event.target;
          if (tappedTimeout && tappedBefore) {
            clearTimeout(tappedTimeout);
          }
          if(tappedBefore === tappedNow) {
            //tappedNow.trigger('doubleTap', event);
            let node = tappedNow.id()

            if(!(node in expanded)) {
                $("body").addClass("loading");
                let url = `/neighbors/${node}`
                $.getJSON(url, function (data, textStatus) {
                    let elements = JSON.parse(data)
                    cy.add(elements)
                    expanded[node] = elements
                    $("body").removeClass("loading");
                    cy.layout(layoutOpts).run();
                    cy.fit(cy.elements())
                    cy.zoom(1)
                })
            }
            else{
                let elements = expanded[node]
                let ids = new Set(elements.map((e) => e['data']['id']))


                ids.forEach(function(e) {
                    if(node !== e)
                        cy.remove(cy.$id(e))
                })

                delete expanded[node]
            }


            tappedBefore = null;
            originalTapEvent = null;
          } else {
            tappedTimeout = setTimeout(function(){ tappedBefore = null; }, 300);
            tappedBefore = tappedNow;
          }
        });


        $( ".entity" ).autocomplete({
          source: '/entities', minLength: 2, delay: 1000
        });

        // Take the arguments of the query string as pre-populated values of the query inputs
        const urlParams = new URLSearchParams(window.location.search);

        if(urlParams.has("src")){
            $("#source").val(urlParams.get("src"))
        }

        if(urlParams.has("dst")){
            $("#destination").val(urlParams.get("dst"))
        }

        if(urlParams.has("bidirect")){
            $("#bidirectional").prop('checked', true)
        }

        if(urlParams.has("src") && urlParams.has("dst")) {
            $("#ask").trigger("click")
        }

        $("#bidirectional").click(() => { $("#ask").trigger("click") })

        $("#close_evidence").click(() => {
            $("#evidence_pane").hide()
        })

        const showWeightControls = window.localStorage.getItem("show-weight")

        if(showWeightControls === "true"){
            $("#weight_group").show()
            $("#toggle_weight").text("[Hide]")
        }

        $("#toggle_weight").click(() => {
            if(!$("#weight_group").is(":hidden")){
                $("#weight_group").hide()
                $("#toggle_weight").text("[Show]")
                window.localStorage.setItem("show-weight", false)
            }
            else{
                $("#weight_group").show()
                $("#toggle_weight").text("[Hide]")
                window.localStorage.setItem("show-weight", true)
            }
        })

      </script>

<div class="modal"><!-- Place at bottom of page --></div>



</body>
</html>
